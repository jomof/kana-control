<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>&lt;kana-control&gt; Demo</title>
  <script src="../node_modules/@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
  <script src="../node_modules/lit/polyfill-support.js"></script>
  <script type="module" src="../kana-control.js"></script>
  <link rel="stylesheet" href="./dev.css" />
</head>

<body>
  <script type="module">
    document.addEventListener('readystatechange', () =>
      console.log('readystatechange:', document.readyState)
    );

    import { makeQuestion } from '../kana-control.js';

    // Load questions and grammar data from JSON file
    async function initializeDemo() {
      const control = document.querySelector('kana-control');
      if (!control) {
        console.error('kana-control element not found!');
        return;
      }

      try {
        console.log('Loading demo data from grammar.json...');
        const response = await fetch('./grammar.json');
        const data = await response.json();
        const { questions: questionSources, grammar: grammarData } = data;

        console.log('Creating questions...');
        const questions = await Promise.all(
          questionSources.map(source =>
            makeQuestion(source.english, source.japanese, grammarData)
          )
        );

        console.log('Questions created:', questions);

        let currentIndex = 0;

        // Load first question
        console.log('Loading first question...');
        await control.supplyQuestion(questions[currentIndex]);
        console.log('First question loaded. parsedEnglish:', control.parsedEnglish);

        // Enable debug mode
        control.debug = false;

        const advanceQuestion = async () => {
          currentIndex = (currentIndex + 1) % questions.length;
          console.log('Loading question', currentIndex);
          await control.supplyQuestion(questions[currentIndex]);
        };

        control.addEventListener('question-complete', (e) => {
          const { finalSkeleton, wrongAttempts, correctAttempts, englishHints, score } = e.detail;
          console.log('Question completed!');
          console.log(`  finalSkeleton (string): "${finalSkeleton}"`);
          console.log(`  wrongAttempts (number): ${wrongAttempts}`);
          console.log('  correctAttempts (string[]):', correctAttempts);
          console.log('  englishHints (string[]):', englishHints);
          console.log(`  score (number): ${score}`);
        });

        control.addEventListener('question-skipped', (e) => {
          const { finalSkeleton, wrongAttempts, correctAttempts, englishHints, score } = e.detail;
          console.log('Question skipped!');
          console.log(`  finalSkeleton (string): "${finalSkeleton}"`);
          console.log(`  wrongAttempts (number): ${wrongAttempts}`);
          console.log('  correctAttempts (string[]):', correctAttempts);
          console.log('  englishHints (string[]):', englishHints);
          console.log(`  score (number): ${score}`);
        });

        // Listen for request-next-question event from the component
        control.addEventListener('request-next-question', () => {
          console.log('Received request-next-question event');
          advanceQuestion();
        });

        console.log('Questions loaded. Click words with furigana to toggle pronunciation hints!');
      } catch (error) {
        console.error('Failed to initialize demo:', error);
      }
    }

    // Wait for DOM to be ready
    window.addEventListener('DOMContentLoaded', initializeDemo);
  </script>

  <div class="demo">
    <kana-control></kana-control>
  </div>


  <pre id="debug" hidden></pre>
</body>

</html>